#!/usr/bin/env bash
set -euo pipefail

usage(){ echo "Usage: $0 {all|disk|phone}"; exit 1; }
[ $# -ne 1 ] && usage

EXCLUDES=(
  Downloads
  Games
  .openjfx
  .minecraft
  .vscode
  .cache
  .local/state
  .local/share/Steam
  .local/share/Trash
  .local/share/containers
  .config/Signal
  .config/chromium
  .config/vesktop
  .var/app
  .librewolf/*/storage/default/https+++*
)
PHONE_EXCLUDES=(
  Phone
  Pictures/google-photos
  Pictures/OnePlus
)

disk(){
  EXCLUDES=( "${EXCLUDES[@]/#/--exclude=/}" )
  rsync -a /etc/nixos/ ~/Backups/nixos/

  dest="/run/media/chika/backup/"
  mountpoint -q "$dest" || { echo "Destination not mounted"; exit 1; }

  rsync -av --delete-excluded --info=progress2 \
    "${EXCLUDES[@]}" \
    "$HOME/." "$dest"

  udisksctl unmount -b /dev/disk/by-label/backup
}

phone(){
  EXCLUDES=( "${EXCLUDES[@]/#/--exclude=./}" "${PHONE_EXCLUDES[@]/#/--exclude=./}" )

  outfile="$HOME/Downloads/backup-$(date +%Y%m%d).tar.zstd"
  echo "Creating $outfile…"
  until
    tar -C "$HOME" "${EXCLUDES[@]}" --zstd -cf - . 2>/dev/null \
      | nix run nixpkgs#pv -- -s "$(cd "$HOME"; du -sb "${EXCLUDES[@]}" 2>/dev/null | cut -f1)" \
      > "$outfile";
  do sleep 1; done

  echo "Sending to phone…"
  until /run/current-system/sw/share/gnome-shell/extensions/gsconnect@andyholmes.github.io/service/daemon.js --device=0e173162a1ad4d08a680097d7f7fb022 --share-file="$outfile"; do sleep 1; done
}

case "$1" in
  all)   disk; phone ;;
  disk)  disk        ;;
  phone) phone       ;;
  *)     usage       ;;
esac
